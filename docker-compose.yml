services:
  clickhouse:
    container_name: clickhouse
    image: clickhouse/clickhouse-server:24.12.3
    ports:
      - '9000:9000'
      - '8123:8123'
    networks:
      - hotrod-example

  otelcol:
    container_name: otelcol
    image: wesha/otel-clickhouse:0.4.0
    restart: on-failure:10
    networks:
      - hotrod-example
    depends_on:
      - clickhouse

  hotrod-frontend:
    container_name: hotrod-frontend
    image: hotrod:0.1.0-alpha.2
    ports:
      - '8080:8080'
    command: ["frontend", "--customer-service-hostname", "hotrod-customer", "-c", "8081", "--driver-service-hostname", "hotrod-driver", "-d", "8082", "--route-service-hostname", "hotrod-route", "-r", "8083"]
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4318
    networks:
      - hotrod-example
    depends_on:
      - otelcol
      - hotrod-customer
      - hotrod-driver
      - hotrod-route

  hotrod-customer:
    container_name: hotrod-customer
    image: hotrod:0.1.0-alpha.2
    ports:
      - '8081:8081'
    command: ["customer", "-c", "8081"]
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4318
    networks:
      - hotrod-example
    depends_on:
      - otelcol

  hotrod-driver:
    container_name: hotrod-driver
    image: hotrod:0.1.0-alpha.2
    ports:
      - '8082:8082'
    command: ["driver", "-d", "8082"]
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4318
    networks:
      - hotrod-example
    depends_on:
      - otelcol

  hotrod-route:
    container_name: hotrod-route
    image: hotrod:0.1.0-alpha.2
    ports:
      - '8083:8083'
    command: ["route", "-r", "8083"]
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4318
    networks:
      - hotrod-example
    depends_on:
      - otelcol

  backend:
    container_name: backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: on-failure:10
    ports:
      - '4000:4000'
    environment:
      - NAMESPACE=hotrod
      - NAME=backend
      - VERSION=0.1.0-alpha.0
      - HTTP_ADDRESS=:4000
      - STORE=clickhouse
      - STORE_ADDRESS=tcp://clickhouse:9000
      - DB=default
      - TABLE=otel_traces
    networks:
      - hotrod-example
    depends_on:
      - clickhouse
  
  frontend:
    container_name: frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: on-failure:10
    ports:
      - '3000:3000'
    networks:
      - hotrod-example
    depends_on:
      - backend

networks:
  hotrod-example:
